#!/usr/bin/env node

/**
 * Build Script: Auto-generate test-overlays.html from index.html
 *
 * Extracts overlay HTML structures from index.html and injects them into
 * the test page template, ensuring the test page stays in sync with production.
 *
 * Usage: node scripts/build-test-page.js
 */

const fs = require('fs');
const path = require('path');

// Get project root directory
const projectRoot = path.join(__dirname, '..');

// File paths
const indexPath = path.join(projectRoot, 'wwwroot', 'index.html');
const templatePath = path.join(projectRoot, 'wwwroot', 'test-overlays.template.html');
const outputPath = path.join(projectRoot, 'wwwroot', 'test-overlays.html');

console.log('üî® Building test-overlays.html...');

try {
    // Read source files
    const indexHtml = fs.readFileSync(indexPath, 'utf-8');
    const template = fs.readFileSync(templatePath, 'utf-8');

    // Extract overlay sections from index.html
    const overlays = extractOverlays(indexHtml);

    if (!overlays) {
        throw new Error('Failed to extract overlay HTML from index.html');
    }

    console.log(`  ‚úì Extracted ${countOverlays(overlays)} overlay elements`);

    // Inject overlays into template
    const result = injectOverlays(template, overlays);

    // Write generated file
    fs.writeFileSync(outputPath, result);

    console.log('  ‚úì Generated wwwroot/test-overlays.html');
    console.log('‚úÖ Build complete!');

} catch (error) {
    console.error('‚ùå Build failed:', error.message);
    process.exit(1);
}

/**
 * Extract overlay HTML from index.html
 */
function extractOverlays(html) {
    // Find start marker (first overlay comment)
    const startMarker = '<!-- Inventory Overlay -->';
    const startIdx = html.indexOf(startMarker);

    if (startIdx === -1) {
        throw new Error('Could not find start marker: ' + startMarker);
    }

    // Find end marker (before tile popup or scripts section)
    const endMarker = '<!-- Tile Popup -->';
    const endIdx = html.indexOf(endMarker);

    if (endIdx === -1) {
        throw new Error('Could not find end marker: ' + endMarker);
    }

    // Extract the overlays section
    return html.substring(startIdx, endIdx).trim();
}

/**
 * Inject overlays into template
 */
function injectOverlays(template, overlays) {
    const placeholder = '<!-- OVERLAYS_PLACEHOLDER -->';

    if (!template.includes(placeholder)) {
        throw new Error('Template does not contain placeholder: ' + placeholder);
    }

    // Add generation notice
    const notice = `<!-- ‚ö†Ô∏è  AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY ‚ö†Ô∏è
     This file is generated by scripts/build-test-page.js
     To make changes, edit wwwroot/test-overlays.template.html and run:
     npm run build:test-page
-->\n\n`;

    return notice + template.replace(placeholder, overlays);
}

/**
 * Count overlay elements for logging
 */
function countOverlays(overlaysHtml) {
    const matches = overlaysHtml.match(/id="[^"]*Overlay"/g);
    return matches ? matches.length : 0;
}
